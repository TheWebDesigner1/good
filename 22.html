<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ Cloudflare AI Chat</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#1e1e2f; color:#eee; display:flex; justify-content:center; align-items:center; height:100vh; margin:0;}
#chat-container { width:600px; height:700px; display:flex; flex-direction:column; background:#2a2a3e; border-radius:15px; overflow:hidden; box-shadow:0 5px 30px rgba(0,0,0,0.7);}
#chat-box { flex:1; padding:20px; overflow-y:auto; scroll-behavior:smooth;}
.message { max-width:80%; margin:10px 0; padding:12px 18px; border-radius:20px; word-wrap:break-word;}
.user { background:#4f9eff; align-self:flex-end;}
.ai { background:#00d4aa; align-self:flex-start;}
#input-container { display:flex; padding:10px; background:#1e1e2f;}
input { flex:1; padding:12px; border-radius:25px; border:none; outline:none; font-size:16px;}
button { margin-left:10px; padding:12px 20px; border:none; border-radius:25px; background:#4f9eff; color:white; font-weight:bold; cursor:pointer; transition:0.2s;}
button:hover { background:#2c7ce2;}
</style>
</head>
<body>

<div id="chat-container">
  <div id="chat-box"></div>
  <div id="input-container">
    <input type="text" id="user-input" placeholder="Type your message..." onkeydown="if(event.key==='Enter') sendMessage()">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<script>
const API_KEY = "Id86ob7fgcegYMHiJNt-1YQXFUq-wB3S31-2r2CC";
const MODEL = "@cf/meta/llama-3-8b-instruct";
let chatHistory = [
  { role: "system", content: "You are a friendly assistant that helps write stories." }
];
const chatBox = document.getElementById('chat-box');

function addMessage(sender, text){
    const msg = document.createElement('div');
    msg.className = 'message ' + sender;
    msg.textContent = text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
    return msg;
}

function sleep(ms){ return new Promise(resolve => setTimeout(resolve, ms)); }

async function run(model, input) {
  const response = await fetch(
    `https://api.cloudflare.com/client/v4/accounts/3188625e4b5c056665de3a5953a784a2/ai/run/${model}`,
    {
      headers: { Authorization: "Bearer " + API_KEY },
      method: "POST",
      body: JSON.stringify(input),
    }
  );
  const result = await response.json();
  return result;
}

async function sendMessage(){
    const inputField = document.getElementById('user-input');
    const userMessage = inputField.value.trim();
    if(!userMessage) return;

    addMessage('user', userMessage);
    inputField.value = '';

    addMessage('ai', 'Typing...');

    chatHistory.push({ role: "user", content: userMessage });

    try{
        const response = await run(MODEL, { messages: chatHistory });
        const aiContent = response.output_text || "Sorry, I could not respond.";

        // Remove typing
        const typingMsg = document.querySelector('.ai:last-child');
        if(typingMsg && typingMsg.textContent === 'Typing...') typingMsg.remove();

        // Typing effect
        let msgElem = addMessage('ai','');
        for(let char of aiContent){
            msgElem.textContent += char;
            await sleep(20);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        chatHistory.push({ role: "assistant", content: aiContent });

    }catch(err){
        const typingMsg = document.querySelector('.ai:last-child');
        if(typingMsg && typingMsg.textContent === 'Typing...') typingMsg.remove();
        addMessage('ai', "Error: " + err.message);
    }
}
</script>

</body>
</html>
